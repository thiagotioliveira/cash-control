<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Transactions Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

<div id="mixedChart"></div>

<!-- Container para os gráficos de pizza mensais -->
<div id="monthlyPieCharts"></div>

<script th:inline="javascript">

    /*<![CDATA[*/

    const mixedData = /*[[${mixedData}]]*/ [];
    const pieData = /*[[${monthlyPieCharts}]]*/ [];

    const labels = mixedData.map(d => {
        const [year, month] = d.yearMonth.split("-");
        return month + "/" + year;
    });

    const credit = mixedData.map(d => d.credit);
    const debit = mixedData.map(d => d.debit);
    const balance = mixedData.map(d => d.balance);

    // Formatter para Euro
    const euroFormatter = new Intl.NumberFormat('pt-PT', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    // -------------------------------
    // Mixed chart
    // -------------------------------
    var mixedOptions = {
        chart: { type: 'line', height: 450 },
        stroke: { width: [0, 0, 3] },
        dataLabels: { enabled: true, formatter: val => euroFormatter.format(val) },
        series: [
            { name: "Crédito", type: "column", data: credit },
            { name: "Débito", type: "column", data: debit },
            { name: "Balanço acumulado", type: "line", data: balance }
        ],
        colors: ['#28a745', '#dc3545', '#007bff'],
        xaxis: { categories: labels },
        yaxis: [
            {
                title: { text: "Valores" },
                labels: { formatter: val => euroFormatter.format(val) }
            }
        ],
        tooltip: { y: { formatter: val => euroFormatter.format(val) } }
    };

    var mixedChart = new ApexCharts(document.querySelector("#mixedChart"), mixedOptions);
    mixedChart.render();

    // -------------------------------
    // Pie charts mensais
    // -------------------------------
    const monthlyContainer = document.querySelector("#monthlyPieCharts");

    pieData.forEach(d => {
        const pieDiv = document.createElement("div");
        pieDiv.id = "pieChart-" + d.yearMonth;
        pieDiv.style.height = "350px";
        pieDiv.style.marginBottom = "30px";
        monthlyContainer.appendChild(pieDiv);

        const categories = d.transactions.map(t => t.categoryName);
        const amounts = d.transactions.map(t => t.amount);
        const colors = d.transactions.map(t => t.categoryHashColor);

        var pieOptions = {
            chart: { type: 'pie', height: 350 },
            labels: categories,
            series: amounts,
            colors: colors,
            tooltip: { y: { formatter: val => {
                        const total = amounts.reduce((a, b) => a + b, 0);
                        const percent = (val / total) * 100;
                        return percent.toFixed(2) + '%';
                    } } },
            legend: { position: 'bottom' },
            dataLabels: { formatter: val => val.toFixed(2) + '%' },
            title: {
                text: "Distribuição por categoria - " + d.yearMonth,
                align: 'center'
            }
        };

        var pieChart = new ApexCharts(pieDiv, pieOptions);
        pieChart.render();
    });

    /*]]>*/
</script>


</body>
</html>
